import{r as p,ad as G,a2 as $,c as J,w as B,o as u,g as r,b as m,Y as ee,X as d,Z as S,_ as x,i as ae,$ as te,ag as F,L as I,ap as le,aq as se,p as oe,m as D,a9 as ne,q as w,W as re,ar as ue}from"./index-jHQwErwV.js";import{P as ie}from"./pageContainer-qlUKgolJ.js";/* empty css                  */import{a as ce}from"./material-BJYmwKQa.js";/* empty css                     */import{c as de,t as pe}from"./pageTypes-x8DazHtP.js";import{a as ge}from"./request-Bf4HgDwi.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";const me="data:image/png;base64,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",Ee={class:"cateSelect"},ve={class:"showFile"},Be={class:"fileContent"},Qe={key:0,class:"upload-progress"},Ae={class:"progress-info"},he={key:1,class:"retry-failed"},ye={class:"retry-content"},Ce={class:"failed-files"},Se={class:"fileName"},xe={class:"left"},Ie={class:"name"},we=["onClick"],Ne={key:2,class:"empty-files"},be={class:"submitBtn"},ke={__name:"ManySend",setup(Je){const T=de(),A=p(""),U=()=>{h.value="",y.value="",N.value="",b.value="",V()},h=p(""),y=p(""),N=p(""),b=p(""),M=p([]),R=p([]),V=async()=>{const t=await pe(A.value);M.value=t.data,R.value=t.data.flatMap(e=>e.subCategories||[])},O=t=>{y.value="",b.value="",N.value=t;const e=M.value.find(l=>l._id===t);e&&(h.value=e.name)},X=t=>{b.value=t;const e=R.value.find(l=>l._id===t);e&&(y.value=e.name)},c=p([]),n=p({uploading:!1,total:0,current:0,success:0,failed:0,currentFile:null,currentProgress:0}),K=G(()=>{const t={};return c.value.forEach(e=>{const l=e.name.split(".")[0];t[l]||(t[l]=[]),t[l].push(e)}),t}),Y=G(()=>{const t=[],e={};return Object.entries(K.value).forEach(([l,a])=>{e[l]||(e[l]=[]),a.forEach(o=>{e[l].push(o)})}),Object.entries(e).forEach(([l,a])=>{t.push({groupName:l,files:a})}),t}),z=t=>{c.value.filter(l=>l.name.split(".")[0]===t).forEach(l=>{const a=c.value.findIndex(o=>o.uid===l.uid);a!==-1&&c.value.splice(a,1)})},Q=p([]),E=p([]),P=t=>{const e=[];for(const[l,a]of Object.entries(t))for(const o of a)e.push({file:o,folderName:l,status:"pending",result:null,retries:0});return e},_=async(t,e,l=0)=>{try{const a=new FormData;a.append("file",t.raw),a.append("type",A.value),a.append("topCate",h.value),a.append("subCate",y.value||""),a.append("folderName",e),n.value.currentFile=t.name,n.value.currentProgress=0;const o=await ge.post("https://etnrve3alw.gzg.sealos.run/material-upload-files",a,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:f=>{const v=Math.round(f.loaded*100/f.total);n.value.currentProgress=v}});return n.value.success++,n.value.currentProgress=100,o.data}catch(a){if(console.error("上传文件失败:",a),l<3)return console.log(`重试上传文件 ${t.name}，第 ${l+1} 次尝试`),await new Promise(o=>setTimeout(o,1e3*(l+1))),_(t,e,l+1);throw n.value.failed++,a}finally{n.value.current++}},H=async t=>{Q.value.length===0&&(Q.value=P(t));const e=Object.values(t).reduce((a,o)=>a+o.length,0);n.value.total=e||Q.value.length;const l=[];for(const a of Q.value){if(a.status==="success"){l.push(a.result);continue}try{a.status="uploading";const o=await _(a.file,a.folderName);a.status="success",a.result={fileName:a.file.name,folderName:a.folderName,url:o,success:!0},l.push(a.result)}catch(o){a.status="failed",a.result={fileName:a.file.name,folderName:a.folderName,error:o.message,success:!1},l.push(a.result),E.value.push(a)}await new Promise(o=>setTimeout(o,100))}return l},Z=async()=>{if(E.value.length===0){w.info("没有失败的上传需要重试");return}return E.value.forEach(t=>{t.status="pending",t.retries=0}),Q.value=E.value,E.value=[],j(!0)},L=t=>{const e=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg"],l=t.toLowerCase();return e.some(a=>l.endsWith(a))},q=t=>{const e=t.filter(l=>L(l.fileName));return e.length>0?e[0]:t[0]},j=async(t=!1)=>{if(!t&&c.value.length===0){w.warning("请先选择文件");return}if(!A.value||!h.value||!N.value){w.warning("请选择分类");return}try{t||await re.confirm(`确定要上传 ${c.value.length} 个文件吗？将自动按文件名分组创建文件夹。`,"上传确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),n.value={uploading:!0,total:t?Q.value.length:c.value.length,current:0,success:0,failed:0,currentFile:null,currentProgress:0};const e=ue.service({lock:!0,text:"正在上传文件...",background:"rgba(0, 0, 0, 0.7)"}),l=await H(K.value);e.close(),n.value.uploading=!1;const a={},o=new Set;l.forEach(i=>{a[i.folderName]||(a[i.folderName]={files:[],hasFailure:!1}),a[i.folderName].files.push(i),i.success||(a[i.folderName].hasFailure=!0,o.add(i.folderName))});let f=0,v=0;for(const[i,s]of Object.entries(a)){if(s.hasFailure){v++;continue}try{const g=q(s.files),k={name:i,cover_url:g.url,files_url:s.files.filter(C=>C!==g&&C.success).map(C=>C.url),top_id:N.value,sub_id:b.value||"",type:A.value,tags:[],colors:[],status:1};await ce(k),f++}catch(g){console.error(`文件夹 ${i} 发布失败:`,g),v++,o.add(i)}}n.value.failed===0&&v===0?(w.success(`所有 ${n.value.total} 个文件上传并发布成功！`),Q.value=[],E.value=[],c.value=[]):(c.value=c.value.filter(i=>{const s=i.name.split(".")[0];return o.has(s)}),w.warning(`上传完成：成功 ${n.value.success} 个，失败 ${n.value.failed} 个
发布完成：成功 ${f} 个文件夹，失败 ${v} 个文件夹`))}catch(e){e!=="cancel"&&w.error("上传过程中发生错误: "+e.message),n.value.uploading=!1}},W=()=>{const t=document.createElement("input");t.type="file",t.multiple=!0,t.onchange=e=>{Array.from(e.target.files).forEach(a=>{const o={uid:Date.now()+Math.random().toString(36).substring(2),name:a.name,size:a.size,raw:a};c.value.push(o)})},t.click()};return $(()=>{}),(t,e)=>{const l=te,a=ee,o=le,f=oe,v=se,i=ne;return u(),J(ie,{title:"批量发布"},{default:B(()=>[r("div",Ee,[e[3]||(e[3]=r("div",{class:"title"},"所属分类",-1)),m(a,{modelValue:A.value,"onUpdate:modelValue":e[0]||(e[0]=s=>A.value=s),onChange:U,placeholder:"Select",size:"default",style:{width:"240px","margin-right":"10px"}},{default:B(()=>[(u(!0),d(S,null,x(ae(T).pageType,(s,g)=>(u(),J(l,{key:g,value:s},null,8,["value"]))),128))]),_:1},8,["modelValue"]),m(a,{modelValue:h.value,"onUpdate:modelValue":e[1]||(e[1]=s=>h.value=s),onChange:O,placeholder:"Select",size:"default",style:{width:"240px","margin-right":"10px"}},{default:B(()=>[(u(!0),d(S,null,x(M.value,s=>(u(),J(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),m(a,{modelValue:y.value,"onUpdate:modelValue":e[2]||(e[2]=s=>y.value=s),onChange:X,placeholder:"Select",size:"default",style:{width:"240px","margin-right":"10px"}},{default:B(()=>[(u(!0),d(S,null,x(R.value,s=>(u(),J(l,{key:s._id,label:s.name,value:s._id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),r("div",ve,[e[7]||(e[7]=r("div",{class:"title"},"附件",-1)),r("div",Be,[n.value.uploading?(u(),d("div",Qe,[r("div",Ae,[r("span",null,"正在上传: "+I(n.value.currentFile),1),r("span",null,"总进度: "+I(n.value.current)+"/"+I(n.value.total),1)]),m(o,{percentage:n.value.currentProgress,status:n.value.currentProgress===100?"success":""},null,8,["percentage","status"])])):F("",!0),!n.value.uploading&&E.value.length>0?(u(),d("div",he,[m(v,{title:"部分文件上传失败",type:"warning",closable:!1,"show-icon":""},{default:B(()=>[r("div",ye,[r("div",Ce,[e[4]||(e[4]=r("div",null,"失败文件列表：",-1)),(u(!0),d(S,null,x(E.value,(s,g)=>(u(),d("div",{key:g,class:"failed-file"},I(s.file.name),1))),128))]),m(f,{type:"primary",size:"small",onClick:Z},{default:B(()=>e[5]||(e[5]=[D(" 重试失败文件 ")])),_:1})])]),_:1})])):F("",!0),(u(!0),d(S,null,x(Y.value,(s,g)=>(u(),d("div",{class:"fileItem",key:g},[r("div",Se,[r("div",xe,[e[6]||(e[6]=r("img",{src:me,alt:"icon",style:{width:"18px",height:"18px"}},null,-1)),r("div",Ie,I(s.groupName),1)]),r("div",{style:{cursor:"pointer",color:"#999999"},onClick:k=>z(s.groupName)},"删?",8,we)]),(u(!0),d(S,null,x(s.files,(k,C)=>(u(),d("div",{key:C,class:"file",style:{"margin-top":"8px","background-color":"#fafafa",padding:"8px",color:"#a8a8a8","font-size":"14px"}},I(k.name),1))),128))]))),128)),c.value.length===0?(u(),d("div",Ne,[m(i,{description:"暂无文件，请点击'继续添加'选择文件"})])):F("",!0)])]),r("div",be,[m(f,{type:"primary",onClick:j},{default:B(()=>e[8]||(e[8]=[D("发布上传")])),_:1}),m(f,{onClick:W},{default:B(()=>e[9]||(e[9]=[D("继续添加")])),_:1})])]),_:1})}}},Te=fe(ke,[["__scopeId","data-v-fef44c55"]]);export{Te as default};
